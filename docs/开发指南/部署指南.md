# 部署指南

> 本文档描述 PrismaX-Desktop 桌面应用的打包和分发流程

---

## 概述

PrismaX-Desktop 桌面应用支持 Windows、macOS 和 Linux 三个平台的打包分发。

---

## 打包配置

### electron-builder 配置

```json
// electron-builder.json
{
  "appId": "com.prismax.desktop",
  "productName": "PrismaX-Desktop",
  "directories": {
    "output": "release"
  },
  "files": [
    "dist/**/*",
    "electron-dist/**/*",
    "!node_modules/**/*",
    "node_modules/better-sqlite3/**/*",
    "node_modules/@lancedb/**/*",
    "node_modules/apache-arrow/**/*"
  ],
  "asar": true,
  "asarUnpack": ["node_modules/better-sqlite3/**/*", "node_modules/@lancedb/**/*"],
  "mac": {
    "category": "public.app-category.productivity",
    "icon": "resources/icons/icon.icns",
    "target": ["dmg", "zip"],
    "hardenedRuntime": true,
    "gatekeeperAssess": false
  },
  "win": {
    "icon": "resources/icons/icon.ico",
    "target": ["nsis", "portable"]
  },
  "linux": {
    "icon": "resources/icons",
    "target": ["AppImage", "deb"],
    "category": "Utility"
  },
  "nsis": {
    "oneClick": false,
    "allowToChangeInstallationDirectory": true,
    "createDesktopShortcut": true,
    "createStartMenuShortcut": true
  }
}
```

说明（原生依赖分发）：

- `better-sqlite3` 与 `@lancedb/lancedb` 都依赖原生模块；打包时需要确保其 `.node` 文件在 `asarUnpack` 中可被运行时加载。
- 知识库 worker（独立子进程脚本）需要能被 `fork` 执行；当前项目配置中也会将 `electron-dist/knowledge/kb-worker.cjs` 解包（见实际 `electron-builder.json`）。
- 跨平台打包时，建议在目标平台/架构环境执行 `pnpm install`（以获取对应平台的 `@lancedb/lancedb-<platform>` 可选依赖），再运行 `pnpm package`。

---

## 打包命令

### 构建所有平台

```bash
# 构建前端和主进程
pnpm build:all

# 打包所有平台
pnpm package
```

### 单独打包

```bash
# 仅打包 macOS
pnpm package --mac

# 仅打包 Windows
pnpm package --win

# 仅打包 Linux
pnpm package --linux
```

---

## 平台特定配置

### macOS

#### 代码签名

```bash
# 设置环境变量
export CSC_LINK=/path/to/certificate.p12
export CSC_KEY_PASSWORD=your-password

# 打包并签名
pnpm package --mac
```

#### 公证 (Notarization)

```bash
# 设置 Apple ID 凭据
export APPLE_ID=your-apple-id@example.com
export APPLE_APP_SPECIFIC_PASSWORD=xxxx-xxxx-xxxx-xxxx
export APPLE_TEAM_ID=XXXXXXXXXX

# 打包并公证
pnpm package --mac
```

### Windows

#### 代码签名

```bash
# 设置环境变量
export WIN_CSC_LINK=/path/to/certificate.pfx
export WIN_CSC_KEY_PASSWORD=your-password

# 打包并签名
pnpm package --win
```

### Linux

```bash
# 打包为 AppImage 和 deb
pnpm package --linux
```

---

## 输出目录结构

```
release/
├── mac/
│   ├── PrismaX-Desktop-1.0.0.dmg
│   └── PrismaX-Desktop-1.0.0-mac.zip
├── win/
│   ├── PrismaX-Desktop-Setup-1.0.0.exe
│   └── PrismaX-Desktop-1.0.0-portable.exe
└── linux/
    ├── PrismaX-Desktop-1.0.0.AppImage
    └── prismax_1.0.0_amd64.deb
```

---

## 更新检查

### 实现

```typescript
// electron/updater.ts
import { dialog, shell } from "electron";

interface UpdateInfo {
  version: string;
  releaseNotes: string;
  downloadUrl: string;
}

export async function checkForUpdates(): Promise<UpdateInfo | null> {
  try {
    const response = await fetch(
      "https://api.github.com/repos/your-username/prismax/releases/latest",
    );
    const release = await response.json();

    const currentVersion = app.getVersion();
    const latestVersion = release.tag_name.replace("v", "");

    if (latestVersion > currentVersion) {
      return {
        version: latestVersion,
        releaseNotes: release.body,
        downloadUrl: release.html_url,
      };
    }

    return null;
  } catch (error) {
    console.error("检查更新失败:", error);
    return null;
  }
}

export async function promptUpdate(updateInfo: UpdateInfo) {
  const result = await dialog.showMessageBox({
    type: "info",
    title: "发现新版本",
    message: `新版本 ${updateInfo.version} 可用`,
    detail: updateInfo.releaseNotes,
    buttons: ["前往下载", "稍后提醒"],
  });

  if (result.response === 0) {
    shell.openExternal(updateInfo.downloadUrl);
  }
}
```

---

## 发布流程

### 1. 更新版本号

```bash
# 更新 package.json 中的版本号
npm version patch  # 1.0.0 -> 1.0.1
npm version minor  # 1.0.0 -> 1.1.0
npm version major  # 1.0.0 -> 2.0.0
```

### 2. 构建和打包

```bash
# 构建所有平台
pnpm build:all
pnpm package
```

### 3. 创建 GitHub Release

```bash
# 创建标签
git tag v1.0.0
git push origin v1.0.0

# 在 GitHub 上创建 Release
# 上传打包好的文件
```

### 4. 发布检查清单

- [ ] 版本号已更新
- [ ] CHANGELOG 已更新
- [ ] 所有平台打包成功
- [ ] 代码签名完成（macOS/Windows）
- [ ] 基本功能测试通过
- [ ] GitHub Release 已创建
- [ ] 下载链接可用

---

## 故障排除

### 常见问题

| 问题                    | 可能原因              | 解决方案                      |
| ----------------------- | --------------------- | ----------------------------- |
| macOS 打包失败          | 缺少 Xcode 命令行工具 | 运行 `xcode-select --install` |
| Windows 签名失败        | 证书过期或无效        | 检查证书有效期                |
| Linux AppImage 无法运行 | 缺少 FUSE             | 安装 `fuse` 或 `libfuse2`     |
| 打包后应用无法启动      | 路径配置错误          | 检查 `files` 配置             |

### 调试打包

```bash
# 启用详细日志
DEBUG=electron-builder pnpm package

# 不压缩，方便调试
pnpm package --dir
```
