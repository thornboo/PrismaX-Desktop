# 项目结构

> 本文档描述 PrismaX 的 Monorepo 项目结构规划

---

## 目录结构

```
PrismaX/
├── apps/                        # 应用层
│   ├── web/                     # Web 版（优先）
│       ├── src/
│       │   ├── app/             # App Router 页面
│       │   │   ├── (auth)/      # 认证相关页面
│       │   │   ├── (main)/      # 主应用页面
│       │   │   └── api/         # API 路由
│       │   ├── server/          # 服务端逻辑
│       │   │   ├── routers/     # tRPC 路由
│       │   │   └── services/    # 业务服务
│       │   └── components/
│       └── package.json
│
│   └── desktop/                 # Electron 桌面壳层（后期）
│       ├── electron/            # Electron 主进程
│       │   ├── main.ts          # 主进程入口
│       │   ├── preload.ts       # 预加载脚本
│       │   ├── ipc/             # IPC 通信处理
│       │   │   ├── index.ts
│       │   │   ├── chat.ts
│       │   │   ├── settings.ts
│       │   │   └── database.ts
│       │   ├── window.ts        # 窗口管理
│       │   ├── tray.ts          # 系统托盘
│       │   ├── updater.ts       # 自动更新
│       │   └── store.ts         # 本地配置存储
│       ├── resources/           # 资源文件
│       │   └── icons/
│       ├── electron-builder.json
│       └── package.json
│
├── packages/                    # 共享包
│   ├── ui/                      # 共享 UI 组件库
│   │   ├── components/          # 通用组件
│   │   │   ├── chat/            # 聊天组件
│   │   │   │   ├── ChatInput.tsx
│   │   │   │   ├── ChatMessage.tsx
│   │   │   │   └── ChatList.tsx
│   │   │   ├── knowledge/       # 知识库组件
│   │   │   ├── settings/        # 设置组件
│   │   │   └── common/          # 通用组件
│   │   │       ├── Button.tsx
│   │   │       ├── Input.tsx
│   │   │       └── Modal.tsx
│   │   ├── hooks/               # 通用 Hooks
│   │   └── styles/              # 共享样式
│   │
│   ├── core/                    # 核心业务逻辑
│   │   ├── chat/                # 聊天核心逻辑
│   │   │   ├── conversation.ts
│   │   │   ├── message.ts
│   │   │   └── streaming.ts
│   │   ├── knowledge/           # 知识库逻辑
│   │   │   ├── embedding.ts
│   │   │   ├── retrieval.ts
│   │   │   └── chunking.ts
│   │   ├── agent/               # Agent 逻辑
│   │   │   ├── runtime.ts
│   │   │   ├── tools.ts
│   │   │   └── planning.ts
│   │   ├── mcp/                 # MCP 协议
│   │   │   ├── client.ts
│   │   │   └── protocol.ts
│   │   └── plugins/             # 插件系统
│   │       ├── loader.ts
│   │       └── registry.ts
│   │
│   ├── database/                # 数据库层
│   │   ├── schema/              # 数据库 Schema
│   │   │   ├── users.ts
│   │   │   ├── conversations.ts
│   │   │   ├── messages.ts
│   │   │   └── knowledge.ts
│   │   ├── migrations/          # 数据库迁移
│   │   └── index.ts
│   │
│   ├── ai-sdk/                  # AI 模型调用封装
│   │   ├── providers/           # 各模型提供商
│   │   │   ├── openai/
│   │   │   ├── anthropic/
│   │   │   ├── google/
│   │   │   ├── qwen/
│   │   │   ├── deepseek/
│   │   │   ├── ollama/
│   │   │   └── custom/
│   │   ├── streaming/           # 流式响应处理
│   │   │   ├── parser.ts
│   │   │   └── transformer.ts
│   │   └── types/               # 类型定义
│   │
│   └── shared/                  # 共享工具
│       ├── types/               # 类型定义
│       ├── utils/               # 工具函数
│       └── constants/           # 常量定义
│
├── docker/                      # Docker 相关配置
│   ├── Dockerfile
│   ├── docker-compose.yml
│   └── docker-compose.dev.yml
│
├── docs/                        # 项目文档
│   ├── 项目概述.md
│   ├── 技术选型/
│   ├── 架构设计/
│   ├── 功能规划/
│   └── 开发指南/
│
├── scripts/                     # 构建脚本
│   ├── build.ts
│   ├── dev.ts
│   └── release.ts
│
├── .notes/                      # 开发笔记（不提交）
│
├── package.json
├── pnpm-workspace.yaml
├── turbo.json
├── tsconfig.json
└── README.md
```

---

## 包依赖关系

```
                    ┌─────────────────┐
                    │    apps/web     │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│  packages/ui  │   │ packages/core │   │packages/ai-sdk│
└───────┬───────┘   └───────┬───────┘   └───────┬───────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                   ┌───────────────┐
                   │packages/shared│
                   └───────────────┘
```

---

## 各包职责

### apps/web

Next.js Web 应用（优先实现），包含：
- 页面路由
- API 路由
- 服务端逻辑
- Web 特有功能

### apps/desktop

Electron 桌面壳层（后期实现），包含：
- 主进程逻辑
- 窗口管理
- 系统集成
- 本地数据库

### packages/ui

共享 UI 组件库，包含：
- 通用 UI 组件
- 业务组件
- 自定义 Hooks
- 样式主题

### packages/core

核心业务逻辑，包含：
- 聊天逻辑
- 知识库逻辑
- Agent 逻辑
- 插件系统

### packages/database

数据库层，包含：
- Schema 定义
- 数据库迁移
- 查询封装

### packages/ai-sdk

AI 模型调用封装，包含：
- 各模型提供商适配
- 流式响应处理
- 统一接口

### packages/shared

共享工具，包含：
- 类型定义
- 工具函数
- 常量定义

---

## 配置文件

### pnpm-workspace.yaml

```yaml
packages:
  - 'apps/*'
  - 'packages/*'
```

### turbo.json

```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "type-check": {
      "dependsOn": ["^build"]
    }
  }
}
```

---

## 开发命令

```bash
# 安装依赖
pnpm install

# 启动 Web 开发服务器
pnpm dev:web

# 启动桌面应用开发
pnpm dev:desktop

# 构建所有包
pnpm build

# 类型检查
pnpm type-check

# 代码检查
pnpm lint

# 运行测试
pnpm test
```
