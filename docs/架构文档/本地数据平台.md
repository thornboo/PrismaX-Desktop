# 本地数据平台（知识库 / 索引 / 任务 / 插件边界）

> 目标：在桌面端提供可扩展、可迁移、可恢复的本地数据底座，支撑知识库（10GB/库，100GB/用户）、插件生态、MCP 市场、笔记等能力，并避免主进程阻塞与数据不可维护。

---

## 背景与约束

- **Local-first**：用户数据默认不出本机。
- **容量上限**：单个知识库可达 10GB；用户总量可达 100GB。
- **导入来源**：本地文件/图片等（后续可扩展）。
- **生态要求**：插件可读写知识库与笔记（用户安装即授权，但仍需工程化边界以保证可维护性）。

对标参考（仅作为工程模式来源）：

- Cherry Studio：数据目录可迁移、per-KB 存储、后台任务限流与删除鲁棒性。
- Chatbox：任务状态机（pending/processing/paused/done/failed）、可恢复索引流水线、存储分层与迁移策略。
- Lobe Chat：工具/插件/MCP/市场的“manifest + registry”组织方式（产品形态与工程组织）。

---

## 设计目标

1. **可迁移**：数据根目录可配置，避免 100GB 写满系统盘；支持搬迁与校验。
2. **可恢复**：导入/索引任务可暂停/恢复/重试；崩溃后可继续；可检测超时并标记失败。
3. **可重建**：索引（FTS/向量）视为派生数据，允许清理与重建，不把长耗时操作塞进迁移。
4. **可替换**：向量索引引擎可插拔（不把上层业务绑死在某个库/扩展上）。
5. **可维护**：插件写入通过 Host API 进行校验与审计，避免“插件直连 DB 导致迁移/一致性不可控”。

非目标（当前阶段，YAGNI）：

- 多端实时协作/CRDT 同步。
- 服务端统一存储与多租户权限体系（可作为未来商业化路线，不影响本地底座边界）。

---

## 概念模型（分层与边界）

### 数据平面（Data Plane）

以“知识库”为最小可搬迁单元：

- **Meta（结构化真源）**：SQLite（Drizzle）存储 KB 元数据、笔记、文档、chunks、任务状态等。
- **Blobs（对象存储）**：导入文件/图片等二进制内容，使用内容寻址（hash）与引用计数（可选）。
- **Index（派生索引）**：
  - **FTS**：全文检索（关键词/短语/过滤）主力。
  - **Vector**：语义检索（embedding + ANN/过滤）。
- **Jobs（任务系统）**：导入/解析/分块/embedding/索引写入/重建索引等后台任务的状态机。

### 控制平面（Control Plane）

- **主进程（Coordinator）**：窗口/托盘/生命周期、权限决策、IPC 编排、限流与审计入口。
- **DB Service（数据服务）**：唯一拥有 Meta DB 写权限（建议独立 worker/子进程），提供事务一致性与 FTS 同步。
- **Indexer Service（索引服务）**：重任务执行者（解析/分块/embedding/向量写入/重建），可并行、可取消、可恢复。
- **Plugin Runtime（插件运行时）**：插件隔离执行，永远不直接拿 DB 连接；通过 Host API 读写。

---

## 目录布局（每个知识库一个目录）

建议将“数据根目录”与“知识库目录”分离：

- 数据根目录（可配置）：`<DataRoot>/`
- 单个知识库目录：`<DataRoot>/KnowledgeBases/<kbId>/`

推荐目录结构：

```
<kbDir>/
  kb.json                 # 知识库清单与版本：id/name/createdAt/schemaVersion/...
  meta.sqlite             # 结构化真源（Drizzle migrations）
  blobs/                  # 原始文件/图片/中间产物（内容寻址）
    sha256/ab/cd/<hash>
  index/
    fts/                  # 可选：FTS 相关派生文件（如需要额外存储）
    vector/               # 向量索引引擎存储目录（可替换实现）
  jobs/                   # 可选：任务日志/检查点（也可全部存 meta.sqlite）
  staging/                # 导入临时区（可清理）
```

说明：

- **meta.sqlite 是唯一真源**；`index/` 可以丢弃并重建。
- **kb.json** 用于快速识别与兼容性检查（schemaVersion/indexVersion 等）。
- 100GB 场景下，必须支持用户把 `<DataRoot>` 放到大盘/外置盘（并做可写性与剩余空间校验）。

---

## 元数据数据库（Meta DB）

### 迁移策略（必须）

当前 `CREATE TABLE IF NOT EXISTS` 只能覆盖“首次创建”，不支持演进。建议统一采用 **Drizzle Kit migrations**：

- 迁移文件随应用发布（resources 内置或随安装包带上）。
- 启动时先执行 migrations，再启动业务 IPC handlers。
- 迁移只做“短且确定”的变更；长耗时（重建索引/回填大数据）写入 Job 后台执行。

### 基础表建议（最小集合）

以知识库为中心（示意，不强制命名）：

- `kb`：知识库元信息（id/name/schemaVersion/indexVersion 等）
- `documents`：导入文档记录（path/mime/hash/size/status/error）
- `attachments`：图片/二进制对象引用（hash/mime/size/refCount）
- `notes`：笔记（title/body/props/updatedAt）
- `chunks`：分块结果（docId/noteId/text/hash/tokenCount/lang/offset）
- `jobs`：任务（type/status/progress/error/retryCount/startedAt/heartbeatAt）
- `audit_log`（建议）：记录插件/系统写入行为（谁、何时、做了什么、影响范围）

---

## 任务系统（Jobs）：可恢复流水线

任务系统解决三个问题：

1. **重任务不阻塞 UI**：导入/解析/索引构建放后台。
2. **可恢复**：崩溃/断电后能继续（通过 checkpoint + status）。
3. **可观测**：进度、错误、重试次数、耗时、最近心跳。

推荐状态机（与 Chatbox 模式一致）：

- `pending` → `processing` → `done`
- `processing` → `paused`（用户暂停/资源不足）
- `processing` → `failed`（可重试）

推荐字段：

- `processing_started_at` / `heartbeat_at`
- `processed_count` / `total_count`（例如 chunk_count/total_chunks）
- `error`（结构化错误码 + message）
- `retry_count`

启动恢复策略：

- `processing` 且长时间无心跳 → 标记为 `failed` 或 `paused`（按任务类型决定）。
- `pending`/`paused` 可被 worker 自动或手动触发恢复。

---

## 索引体系

### 1) 全文检索（FTS5）

定位：笔记/聊天/文档检索的主力，具备可解释性与过滤能力，工程成本低，适合 10–100GB 的“先让产品可用”。

建议采用 “真表 + FTS + trigger 自动同步”：

- 真源：`chunks`
- 派生：`chunks_fts`（FTS5 virtual table）
- 通过 trigger 将 `chunks` 的 insert/update/delete 自动同步到 FTS，避免多入口写入导致不一致（尤其插件写入）。

### 2) 向量检索（Vector）

定位：语义召回；大规模 chunk 场景下需要成熟的 ANN + payload filter。

要求：

- 可按 `kbId/docId/noteId/tags` 等维度过滤。
- 索引可重建（embedding 模型/维度/分块策略变化时）。
- 写入路径必须支持批量与断点续跑。

**关键原则：向量索引引擎必须是可插拔组件**。

建议抽象一个稳定接口（示意）：

- `createIndex(kbId, dimension, version)`
- `upsert(kbId, vectors[], payload[])`
- `query(kbId, queryVector, filter, topK)`
- `deleteByDoc(kbId, docId)` / `dropIndex(kbId)`

### 3) 混合检索（Hybrid）

建议默认走混合策略（可配置）：

1. FTS5 关键词召回（可过滤、可解释）
2. 向量召回（语义）
3. 合并去重 + 简单打分（后续再接 rerank）

---

## 插件边界（即使用户已授权，也必须工程化）

插件“可读写知识库/笔记”不等于“插件直连 DB/目录”：

- **插件一律通过 Host API** 进行读写。
- Host API 负责：
  - 输入校验（schema、大小限制、路径安全）
  - 事务一致性（Meta DB 写入）
  - 触发后台索引任务（Jobs）
  - 审计记录（audit_log）
  - 速率限制与资源配额（避免插件拖垮主进程/索引服务）

插件自定义数据建议：

- 每插件独立存储（`<DataRoot>/Plugins/<pluginId>/...`），不要污染核心 schema。

---

## MCP 与本地能力暴露

建议将“本地能力”统一抽象为工具（tools）：

- 内置工具（KnowledgeBase/Notebook/LocalSystem 等）通过“manifest registry”注册（参考 Lobe Chat）。
- MCP Server 以独立进程/stdio transport 方式接入（参考 Chatbox），由主进程负责进程生命周期与权限控制。

---

## 与当前代码的关系（落地路线）

当前 PrismaX-Desktop 已具备：

- 主进程 IPC 分层（`electron/ipc/handlers.ts` → `electron/services/*`）
- SQLite + Drizzle（`electron/db/*`）

下一阶段建议按“最小风险增量”落地：

1. 数据根目录可配置（避免 100GB 写入 userData 默认路径）。
2. per-KB 目录与 `kb.json/meta.sqlite/blobs/index/jobs` 结构。
3. Jobs 表与 worker（先支持导入与索引的状态机、暂停/恢复/超时处理）。
4. FTS5（先落地 notes/messages/chunks 的全文检索）。
5. 向量引擎通过接口封装落地（先用简单实现，保留替换空间）。
